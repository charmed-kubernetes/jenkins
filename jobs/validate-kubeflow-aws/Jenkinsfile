@Library('juju-pipeline@master') _

def exec(cmd) {
    sh "sudo lxc exec ${CONTAINER} -- bash -c 'cd /project && ${cmd}'"
}

pipeline {
    agent {
        label 'runner-amd64'
    }
    /* XXX: Global $PATH setting doesn't translate properly in pipelines
     https://stackoverflow.com/questions/43987005/jenkins-does-not-recognize-command-sh
     */
    environment {
        PATH = "${utils.cipaths}"
        CONTAINER = "validate-aws-${uuid()}"
        STORAGE = "validate-aws-${uuid()}"
    }
    options {
        ansiColor('xterm')
        timestamps()
        timeout(time: 1, unit: 'HOURS')
    }
    stages {
        stage('Set Start Time') {
            steps {
                setStartTime()
            }
        }
        stage('Setup LXC') {
            steps {
                sh "sudo lxc profile show aws || sudo lxc profile copy default aws"
                sh "sudo lxc profile edit aws < jobs/validate-kubeflow-aws/lxc.profile"
                sh "sudo lxc launch -p default -p aws ubuntu:18.04 ${CONTAINER}"
                sh "sudo lxc storage create ${STORAGE} dir source=/tmp/${STORAGE}"
                sh "sudo lxc storage volume create ${STORAGE} storage"
                sh "sudo lxc storage volume attach ${STORAGE} storage ${CONTAINER} /project"
                sh "sudo cp -r ./* /tmp/${STORAGE}/custom/storage/"
                sh "sudo lxc file push -p ~/.local/share/juju/credentials.yaml ${CONTAINER}/root/.local/share/juju/credentials.yaml"
            }
        }
        stage('Wait for snap') {
            options {
                retry(10)
            }
            steps {
                exec "sudo snap install core"
            }
        }
        stage('Install dependencies') {
            steps {
                exec "sudo snap install charm --classic"
                exec "sudo snap install jq"
                exec "sudo snap install juju --classic --channel ${params.juju_channel}"
                exec "sudo snap install juju-wait --classic"
                exec "sudo snap install yq"
                exec "sudo snap install kubectl --classic"
                exec "sudo apt update && sudo apt install -y python-tox"
            }
        }
        stage('Deploy kubeflow') {
            steps {
                exec "git clone https://github.com/juju-solutions/bundle-kubeflow.git"
                exec "cd bundle-kubeflow && ./scripts/deploy-aws.sh"
                exec 'juju status -m default | grep "kubernetes-worker/0" | awk "{print \\$5}" > PUB_IP'
                exec 'juju scp -m default kubernetes-master/0:~/config kube_config'
            }
        }
        stage('Validate') {
            steps {
                exec '''
                    cd jobs/ && \
                    PY_IGNORE_IMPORTMISMATCH=1
                    CONTROLLER=aws-kf-controller
                    MODEL=aws-kf-model
                    tox
                        -e py36
                        --
                        pytest
                            -v
                            -s
                            --junit-xml=validate.xml
                            integration/test_kubeflow.py::test_validate
            '''.replaceAll('\\s+', ' ')
            }
        }
    }
    post {
        success {
            setPass()
        }
        failure {
            setFail()
        }
        always {
            setEndTime()
            //collectDebug(params.controller, 'default')
        }
        cleanup {
            saveMeta()
            exec "juju status || true"
            exec "juju list-controllers || true"
            exec "juju list-models || true"
            exec "juju kill-controller -y -t0 aws-kf-controller || true"
            sh "sudo lxc storage volume detach ${STORAGE} storage ${CONTAINER} || true"
            sh "sudo lxc delete --force ${CONTAINER} || true"
            sh "sudo lxc storage volume delete ${STORAGE} storage || true"
            sh "sudo lxc storage delete ${STORAGE} || true"
        }
    }
}
