@Library('juju-pipeline@master') _

def exec(cmd) {
    sh "sudo lxc exec ${CONTAINER} -- bash -c 'cd /project && ${cmd}'"
}

pipeline {
    agent {
        label 'runner-amd64'
    }
    /* XXX: Global $PATH setting doesn't translate properly in pipelines
     https://stackoverflow.com/questions/43987005/jenkins-does-not-recognize-command-sh
     */
    environment {
        PATH = "/snap/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin"
        CONTAINER = "validate-microk8s-${uuid()}"
        STORAGE = "validate-microk8s-${uuid()}"
    }
    options {
        ansiColor('xterm')
        timestamps()
        timeout(time: 1, unit: 'HOURS')
    }
    stages {
        stage('Set Start Time') {
            steps {
                setStartTime()
            }
        }
        stage('Setup LXC') {
            steps {
                sh "sudo lxc profile show microk8s || sudo lxc profile copy default microk8s"
                sh "curl https://raw.githubusercontent.com/ubuntu/microk8s/master/tests/lxc/microk8s.profile | sudo lxc profile edit microk8s"
                sh "sudo lxc launch -p default -p microk8s ubuntu:18.04 ${CONTAINER}"
                sh "sudo lxc storage create ${STORAGE} dir source=/tmp/${STORAGE}"
                sh "sudo lxc storage volume create ${STORAGE} storage"
                sh "sudo lxc storage volume attach ${STORAGE} storage ${CONTAINER} /project"
                sh "sudo cp -r ./* /tmp/${STORAGE}/custom/storage/"
            }
        }
        stage('Wait for snap') {
            options {
                retry(10)
            }
            steps {
                exec "sudo snap install core"
            }
        }
        stage('Install dependencies') {
            steps {
                exec "sudo snap install charm --classic"
                exec "sudo snap install jq"
                exec "sudo snap install juju --classic --channel ${params.juju_channel}"
                exec "sudo snap install juju-wait --classic"
                exec "sudo snap install lxd"
                exec "sudo snap install microk8s --classic --channel ${params.microk8s_channel}"
                exec "sudo snap install yq"
                exec "sudo apt update && sudo apt install -y python-tox"
            }
        }
        stage('Deploy kubeflow') {
            steps {
                exec "microk8s.status --wait-ready"
                exec "microk8s.enable dns storage registry"
                exec "juju bootstrap lxd --debug"
                exec "microk8s.config | juju add-k8s microk8s-cloud"
                exec "microk8s.docker build /project/tfjobs/mnist/ -t mnist-test:1.0"

                exec "juju add-model microk8s-model microk8s-cloud"
                exec "juju create-storage-pool operator-storage kubernetes storage-class=microk8s-hostpath"
                exec "juju deploy kubeflow --channel ${params.channel}"

                exec "juju-wait -w"

                exec "juju status | grep 'kubeflow-ambassador ' | awk '{print \$8}' > PUB_IP"
                exec "juju config kubeflow-ambassador juju-external-hostname=localhost"
                exec "juju expose kubeflow-ambassador"
            }
        }
        stage('Validate') {
            steps {
                exec '''
                    cd jobs/ && \
                    PY_IGNORE_IMPORTMISMATCH=1
                    CONTROLLER=localhost-localhost
                    MODEL=microk8s-model
                    tox
                        -e py36
                        --
                        pytest
                            -v
                            -s
                            --junit-xml=validate.xml
                            integration/test_kubeflow.py::test_validate
                '''.replaceAll('\\s+', ' ')
            }
        }
    }
    post {
        success {
            setPass()
        }
        failure {
            setFail()
        }
        always {
            setEndTime()
//            collectDebug(params.controller, juju_model)
        }
        cleanup {
            saveMeta()
            sh "sudo lxc storage volume detach ${STORAGE} storage ${CONTAINER} || true"
            sh "sudo lxc storage volume delete ${STORAGE} storage || true"
            sh "sudo lxc delete --force ${CONTAINER} || true"
            sh "sudo lxc storage delete ${STORAGE} || true"
        }
    }
}
