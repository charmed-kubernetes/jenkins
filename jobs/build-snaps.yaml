# Builds and releases latest snaps

- job-template:
    name: 'promote-snaps-{arch}'
    description: |
      Promotes snaps for {arch} to the snapstore.
    project-type: pipeline
    pipeline-scm:
      scm:
        - k8s-jenkins-jenkaas
      script-path: jobs/build-snaps/promote.groovy
    parameters:
      - string:
          name: arch
          default: '{arch}'
      - string:
          name: build_node
          default: 'runner-{arch}'
      - string:
          name: promote_from
      - string:
          name: promote_to
      - string:
          name: snaps
          description: |
            Pass a list of snap names to promote, leaving empty will promote all snaps
            (kubectl kube-apiserver kube-controller-manager kube-scheduler kubelet
            kube-proxy cdk-addons kubeadm kubernetes-test).
    properties:
      - build-discarder:
          num-to-keep: 2

- job-template:
    name: 'build-release-snaps-{arch}'
    description: |
      Builds, releases and promotes snaps for {arch} to the snapstore.
    project-type: pipeline
    pipeline-scm:
      scm:
        - k8s-jenkins-jenkaas
      script-path: jobs/build-snaps/Jenkinsfile
    parameters:
      - string:
          name: arch
          default: '{arch}'
      - string:
          name: build_node
          default: 'runner-{arch}'
      - bool:
          name: FORCE_RELEASE
          default: false
    triggers:
        - timed: "@daily"
    properties:
      - build-discarder:
          num-to-keep: 2


- job:
    name: 'build-release-eks-snaps'
    description: |
      Builds, releases and promotes Amazon EKS snaps for {version} to the snapstore.
    project-type: pipeline
    pipeline-scm:
      scm:
        - k8s-jenkins-jenkaas
      script-path: jobs/build-snaps/build-release-eks.groovy
    parameters:
      - string:
          name: version
          default: '1.11.5'
          description: snap eks version to build/promote
      - string:
          name: channels
          default: '1.11.5/edge 1.11.5/beta 1.11.5/candidate 1.11.5/stable'
      - bool:
          name: release_only
          default: false
          description: release only, no building or pushing to snapstore.
      - bool:
          name: dry_run
          default: false
          description: dry-run nothing is actually done

    properties:
      - build-discarder:
          num-to-keep: 2

- job:
    name: 'promote-all-arch-snaps'
    description: |
      Promotes snaps for all architectures to the snapstore.
    project-type: pipeline
    pipeline-scm:
      scm:
        - k8s-jenkins-jenkaas
      script-path: jobs/build-snaps/promote-all-arch.groovy
    parameters:
      - string:
          name: promote_from
      - string:
          name: promote_to
      - string:
          name: snaps
          description: |
            Pass a list of snap names to promote, leaving empty will promote all snaps
            (kubectl kube-apiserver kube-controller-manager kube-scheduler kubelet
            kube-proxy cdk-addons kubeadm kubernetes-test).

    properties:
      - build-discarder:
          num-to-keep: 2

- job:
    name: 'create-snap-recipes'
    description: |
      Generates snap recipes for all required snaps.
    project-type: pipeline
    pipeline-scm:
      scm:
        - k8s-jenkins-jenkaas
      script-path: jobs/build-snaps/create-snap-recipes.groovy
    parameters:
      - text:
          name: snaps
          default: !include: includes/k8s-snap-list.inc
          description: YAML list of snaps to create recipe for
      - string:
          name: version
          default: '1.15'
          description: k8s version to target
      - string:
          name: track
          default: '1.15/edge'
          description: snap version/risk/branch
      - string:
          name: owner
          default: 'k8s-jenkaas-admins'
      - string:
          name: tag
          default: 'v1.15.0-alpha.1'
          description: k8s major.minor.patch-{HOTFIX} tag to build from
    properties:
      - build-discarder:
          num-to-keep: 2

- job-group:
    name: 'build-release-snaps'
    jobs:
      - 'build-release-snaps-{arch}':
          arch: ['amd64', 's390x', 'arm64', 'ppc64le']

- job-group:
    name: 'promote-snaps'
    jobs:
      - 'promote-snaps-{arch}':
          arch: ['amd64', 's390x', 'arm64', 'ppc64le']

- project:
    name: build-release-snaps
    jobs:
      - 'build-release-snaps'
      - 'promote-snaps'
