plan:
  - &BASE_JOB
    env:
      - DRY_RUN=no
      - ALWAYS_RELEASE=no
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=release-microk8s-beta
      - JUJU_MODEL=release-microk8s-beta-model
      - ARCH=amd64
    before-script:
      - |
        #!/bin/bash
        set -x
        export JOB_NAME=release-microk8s-beta-$ARCH

        juju destroy-controller -y --destroy-all-models --destroy-storage "$JUJU_CONTROLLER" --debug

        juju bootstrap "$JUJU_CLOUD" "$JUJU_CONTROLLER" \
           -d "$JUJU_MODEL" --model-default test-mode=true \
           --model-default resource-tags=owner=k8sci \
           --bootstrap-constraints "arch=$ARCH"

        juju deploy -m "$JUJU_CONTROLLER":"$JUJU_MODEL" --constraints 'cores=8 mem=32G root-disk=80G' ubuntu

        juju-wait -e "$JUJU_CONTROLLER":"$JUJU_MODEL" -w

    script:
      - |
        #!/bin/bash
        set -x
        export JOB_NAME=release-microk8s-beta-$ARCH

        juju run -m "$JUJU_CONTROLLER":"$JUJU_MODEL" --unit ubuntu/0 'sudo snap install lxd'
        juju run -m "$JUJU_CONTROLLER":"$JUJU_MODEL" --unit ubuntu/0 --timeout=60m0s 'sudo lxd.migrate -yes'
        juju run -m "$JUJU_CONTROLLER":"$JUJU_MODEL" --unit ubuntu/0 --timeout=60m0s 'sudo lxd init --auto'

        DRY_RUN=$DRY_RUN ALWAYS_RELEASE=$ALWAYS_RELEASE \
          TRACKS=$TRACKS TESTS_BRANCH=$TESTS_BRANCH \
          PROXY=$PROXY JUJU_UNIT=ubuntu/0 \
          python3 jobs/microk8s/release-to-beta.py

    after-script:
      - |
        #!/bin/bash
        set -x
        export JOB_NAME=release-microk8s-beta-$ARCH

        python3 jobs/infra/collect-debug.py push 'build_log' ogc.log
        python3 jobs/infra/collect-debug.py push 'metadata' metadata.json
        python3 jobs/infra/collect-debug.py push 'job_result' *job.json
        python3 jobs/infra/collect-debug.py save-meta metadata.json
        juju destroy-controller -y --destroy-all-models --destroy-storage $JUJU_CONTROLLER
  - <<: *BASE_JOB
    env:
      - DRY_RUN=no
      - ALWAYS_RELEASE=no
      - JUJU_CLOUD=aws/us-east-1
      - JUJU_CONTROLLER=release-microk8s-beta
      - JUJU_MODEL=release-microk8s-beta-model
      - ARCH=arm64

meta:
  name: Release Microk8s to Beta
  description: |
    Release Microk8s to beta channels
  mkdocs:
    destination:
      - "releases/microk8s/beta.md"
    jenkins-job-builder:
      jobs:
        - jobs/ci-master.yaml
        - jobs/validate.yaml
